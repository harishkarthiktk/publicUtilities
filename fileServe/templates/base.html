<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Server - {{ root_path }}</title>
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        /* Custom overrides to preserve original behavior */
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
        }
        .main-content .file:hover,.main-content .directory-header:hover{background-color:#f5f5f5;}
        #drop-zone {
            transition: all 0.3s;
            cursor: pointer;
        }
        #drop-zone:hover {
            border-color: #3498db;
            background-color: #f9f9f9;
        }
        #drop-zone.dragover {
            border-color: #3498db;
            background-color: #fbfcfe;
        }
        #progress-indicator {
            transition: width 0.3s;
        }
        .main-content .toggle-icon {
            display: inline-block;
            width: 15px;
            text-align: center;
            font-size: 0.8em;
            color: #666;
            margin-right: 3px;
        }
        .main-content .directory-name {
            font-weight: bold;
            color: #2c3e50;
        }
        .main-content .file-size {
            color: #95a5a6;
            font-size: 0.8em;
            margin-left: 5px;
        }
        .main-content .directory-contents {
            list-style: none;
            padding-left: 20px;
            margin: 3px 0;
        }
    </style>
</head>
<body class="d-flex flex-column min-vh-100 bg-light">
    <!-- Header Bar with Navbar -->
    <nav class="navbar navbar-light bg-light shadow-sm">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">File Server: {{ root_path }}</span>
            <div class="ms-auto">
                <button class="btn btn-outline-primary me-2" onclick="collapseAll()">Collapse All</button>
                <button class="btn btn-outline-primary" onclick="expandFirstLevel()">Expand First Level</button>
                <button class="btn btn-outline-secondary btn-sm ms-2" onclick="togglePanel()">Hide Upload</button>
            </div>
        </div>
    </nav>

    <div class="container-fluid flex-grow-1">
        <div class="row">
            <div class="col-md-9 p-3 main-content">
                {% block content %}{% endblock %}
            </div>
            <div class="col-md-3 bg-light border-start" id="upload-panel">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">Upload Files</h5>
                        <button class="btn btn-sm btn-outline-secondary float-end" onclick="togglePanel()">Hide</button>
                    </div>
                    <div class="card-body">
                        <div id="drop-zone" class="border border-dashed border-secondary rounded p-4 text-center mb-3">
                            Drag & Drop Files or Folders Here<br>
                            <small>or click to select path</small>
                        </div>
                        <div id="upload-progress" style="display:none;">
                            <div class="progress mb-2">
                                <div id="progress-indicator" class="progress-bar bg-success" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div id="progress-text">Preparing upload...</div>
                            <div id="file-list" class="list-group"></div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div id="path-selector" style="display:none;">
                            <label class="form-label">Target Path:</label>
                            <input type="text" class="form-control" id="upload-path" value="" placeholder="subfolder/path">
                            <button id="upload-btn" class="btn btn-primary mt-2">Upload</button>
                            <button id="cancel-btn" class="btn btn-secondary mt-2">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="flask-toast-container" class="position-fixed top-0 end-0 p-3"></div>

    <!-- Bootstrap 5.3 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
    // Toggle Panel Function
    function togglePanel() {
        const panel = document.getElementById('upload-panel');
        panel.classList.toggle('d-none');
    }

    // File browser logic
    function collapseAll() {
        document.querySelectorAll('.directory-contents').forEach(el => {
            el.style.display = 'none';
        });
        document.querySelectorAll('.toggle-icon').forEach(el => {
            el.textContent = '▶';
        });
    }

    function expandFirstLevel() {
        collapseAll();
        document.querySelectorAll('.directory-item > .directory-contents').forEach(el => {
            el.style.display = 'block';
            el.previousElementSibling.querySelector('.toggle-icon').textContent = '▼';
        });
    }

    // Enhanced Toast System
    function escapeHtml(str) {
        if (str == null) return '';
        return String(str)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#39;');
    }

    function showToast(message, type = 'success', title = '', duration = 4000) {
        const container = document.getElementById('flask-toast-container');
        let alertType = type;
        if (type === 'error') {
            alertType = 'danger';
        }
        const el = document.createElement('div');
        el.className = `alert alert-${alertType} alert-dismissible fade mb-2`;
        el.setAttribute('role', 'alert');
        let alertContent = '';
        if (title) {
            alertContent += '<h6 class="alert-heading mb-1">' + escapeHtml(title) + '</h6>';
        }
        alertContent += '<div class="mb-0" style="white-space: pre-wrap;">' + escapeHtml(message) + '</div>';
        el.innerHTML = alertContent + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
        container.appendChild(el);
        requestAnimationFrame(() => el.classList.add('show'));
        if (duration > 0) {
            setTimeout(() => {
                const alertInstance = bootstrap.Alert.getInstance(el);
                if (alertInstance) {
                    alertInstance.close();
                } else {
                    el.classList.remove('show');
                    setTimeout(() => {
                        if (el.parentNode) {
                            el.parentNode.removeChild(el);
                        }
                    }, 150);
                }
            }, duration);
        }
    }


    function formatBytes(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Enhanced Upload Logic
    document.addEventListener('DOMContentLoaded', () => {
        const dropZone = document.getElementById('drop-zone');
        const pathInput = document.getElementById('upload-path');
        const pathSelector = document.getElementById('path-selector');
        const uploadProgressBlock = document.getElementById('upload-progress');
        const progressIndicator = document.getElementById('progress-indicator');
        const progressText = document.getElementById('progress-text');
        const fileListEl = document.getElementById('file-list');
        const uploadBtn = document.getElementById('upload-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        
        let filesToUpload = [];
        let currentXhr = null;

        if (!dropZone) return;

        function resetUploadUI() {
            uploadProgressBlock.style.display = 'none';
            pathSelector.style.display = 'none';
            progressIndicator.style.width = '0%';
            progressIndicator.setAttribute('aria-valuenow', '0');
            progressText.textContent = 'Preparing upload...';
            filesToUpload = [];
            fileListEl.innerHTML = '';
            if (currentXhr) {
                currentXhr.abort();
                currentXhr = null;
            }
        }

        // Drop zone click handler
        dropZone.addEventListener('click', (e) => {
            e.stopPropagation();
            if (filesToUpload.length === 0) {
                // If no files selected, open file picker
                const input = document.createElement('input');
                input.type = 'file';
                input.multiple = true;
                input.onchange = (e) => {
                    if (e.target.files && e.target.files.length > 0) {
                        filesToUpload = Array.from(e.target.files);
                        showFileList(filesToUpload);
                        pathSelector.style.display = 'block';
                    }
                };
                input.click();
            } else {
                // If files already selected, toggle path selector
                pathSelector.style.display = pathSelector.style.display === 'none' ? 'block' : 'none';
            }
        });

        // Drag and drop styling
        ['dragenter', 'dragover'].forEach(evt => {
            dropZone.addEventListener(evt, (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('dragover');
            });
        });

        ['dragleave', 'drop', 'dragend'].forEach(evt => {
            dropZone.addEventListener(evt, (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('dragover');
            });
        });

        // Handle file drop
        dropZone.addEventListener('drop', (e) => {
            const items = e.dataTransfer.files;
            if (!items || items.length === 0) return;
            
            filesToUpload = Array.from(items);
            showFileList(filesToUpload);
            pathSelector.style.display = 'block';
        });

        // Upload button handler
        if (uploadBtn) {
            uploadBtn.addEventListener('click', () => {
                if (filesToUpload.length > 0) {
                    handleFiles(filesToUpload);
                } else {
                    showToast('No files to upload. Please drag and drop files first.', 'warning', 'No Files');
                }
            });
        }

        // Cancel button handler
        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => {
                resetUploadUI();
            });
        }

        function showFileList(files) {
            uploadProgressBlock.style.display = 'block';
            fileListEl.innerHTML = files.map(function(f) { return '<div class="list-group-item d-flex justify-content-between align-items-center"><span>' + escapeHtml(f.name) + '</span><small class="text-muted">(' + formatBytes(f.size) + ')</small></div>'; }).join('');
            progressIndicator.style.width = '0%';
            progressIndicator.setAttribute('aria-valuenow', '0');
            progressText.textContent = 'Ready to upload ' + files.length + ' file(s).';
        }

        function handleFiles(files) {
            if (!files.length) return;

            uploadBtn.disabled = true;
            progressIndicator.style.width = '0%';
            progressIndicator.setAttribute('aria-valuenow', '0');
            progressText.textContent = 'Preparing ' + files.length + ' file(s)...';

            const fd = new FormData();
            files.forEach((f, idx) => {
                fd.append(`file_${idx}`, f, f.name);
            });

            const requestedPath = (pathInput && pathInput.value) ? pathInput.value.trim() : '';
            if (requestedPath) fd.append('path', requestedPath);

            currentXhr = new XMLHttpRequest();
            currentXhr.open('POST', '/upload', true);
            currentXhr.timeout = 300000; // 5 minutes timeout

            currentXhr.upload.onprogress = function (evt) {
                if (evt.lengthComputable) {
                    const percent = Math.round((evt.loaded / evt.total) * 100);
                    progressIndicator.style.width = percent + '%';
                    progressIndicator.setAttribute('aria-valuenow', percent);
                    progressText.textContent = 'Uploading: ' + percent + '% (' + formatBytes(evt.loaded) + ' / ' + formatBytes(evt.total) + ')';
                } else {
                    progressText.textContent = 'Uploading...';
                }
            };

            currentXhr.onload = function () {
                uploadBtn.disabled = false;
                let response;
                
                try {
                    response = JSON.parse(currentXhr.responseText);
                } catch (e) {
                    const errorDetail = currentXhr.responseText ? currentXhr.responseText.substring(0, 200) : 'No response body';
                    showToast('Server returned invalid response: ' + errorDetail, 'error', 'Parse Error', 10000);
                    resetUploadUI();
                    return;
                }

                const { status, message, files: uploadedFiles, errors } = response;

                // Handle successful uploads
                if (status === 'success') {
                    showToast(message, 'success', 'Upload Successful');
                    if (uploadedFiles && uploadedFiles.length > 0) {
                        const filesList = uploadedFiles.map(function(f) { return '• ' + f.name + ' (' + formatBytes(f.size) + ')'; }).join('\n');
                        showToast('Files uploaded:\n' + filesList, 'success', 'Upload Details', 6000);
                    }
                } 
                // Handle partial uploads (some succeeded, some failed)
                else if (status === 'warning') {
                    showToast(message, 'warning', 'Partial Upload', 6000);
                    
                    // Show successful uploads
                    if (uploadedFiles && uploadedFiles.length > 0) {
                        const successList = uploadedFiles.map(function(f) { return '• ' + f.name + ' (' + formatBytes(f.size) + ')'; }).join('\n');
                        showToast('Successfully uploaded:\n' + successList, 'success', 'Successful Files', 6000);
                    }
                    
                    // Show detailed error information for failed files
                    if (Array.isArray(errors) && errors.length > 0) {
                        errors.forEach(err => {
                            const errorType = err.type === 'warning' ? 'warning' : 'error';
                            const errorTitle = err.type === 'warning' ? 'File Warning' : 'File Error';
                            showToast(err.file + ': ' + err.message, errorType, errorTitle, 8000);
                        });
                    }
                } 
                // Handle complete upload failure
                else if (status === 'error') {
                    const errorMessage = message || 'An unknown error occurred during upload.';
                    showToast(errorMessage, 'error', 'Upload Failed', 8000);
                    
                    // Show individual error details if available
                    if (Array.isArray(errors) && errors.length > 0) {
                        errors.forEach(err => {
                            showToast(err.file + ': ' + err.message, 'error', 'File Error', 8000);
                        });
                    }
                }
                // Handle unexpected status
                else {
                    showToast('Unexpected response status: ' + status + '. Message: ' + (message || 'No message'), 'error', 'Unknown Status', 8000);
                }

                progressIndicator.style.width = '100%';
                progressIndicator.setAttribute('aria-valuenow', '100');
                progressText.textContent = 'Upload finished';
                
                // Clear the files after processing and optionally refresh
                setTimeout(() => {
                    resetUploadUI();
                    if (status === 'success' || (status === 'warning' && uploadedFiles && uploadedFiles.length > 0)) {
                        window.location.reload();
                    }
                }, 2000);
            };

            currentXhr.onerror = function () {
                uploadBtn.disabled = false;
                const errorMsg = 'Network error occurred. Status: ' + (currentXhr.status || 'Unknown') + ', StatusText: ' + (currentXhr.statusText || 'No status text');
                showToast(errorMsg, 'error', 'Network Error', 10000);
                resetUploadUI();
            };

            currentXhr.ontimeout = function () {
                uploadBtn.disabled = false;
                showToast('Upload timed out. Please try again with smaller files or check your connection.', 'error', 'Timeout Error', 8000);
                resetUploadUI();
            };

            currentXhr.onabort = function () {
                uploadBtn.disabled = false;
                showToast('Upload was cancelled.', 'warning', 'Upload Cancelled');
                resetUploadUI();
            };

            currentXhr.send(fd);
        }

        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (currentXhr && currentXhr.readyState !== XMLHttpRequest.DONE) {
                currentXhr.abort();
            }
        });
    });
    </script>
</body>
</html>